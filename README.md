# 聊天記錄清洗工具

這是一個用於清洗和處理聊天記錄的工具，可以將原始聊天記錄轉換為結構化的CSV格式。支援智能使用者識別、多格式聊天記錄解析和社群環境優化。

## 🚀 功能特色

- **🤖 智能使用者識別**：基於統計分析自動識別真正使用者
- **📊 格式自動檢測**：自動識別私聊和社群格式
- **🔄 多格式支援**：支援製表符、空格分隔等多種格式
- **📅 時間戳解析**：正確處理多種時間格式
- **🔍 日期過濾**：根據設定的日期範圍過濾訊息
- **🚫 關鍵字過濾**：排除包含特定關鍵字的訊息
- **⭐ 關注對象標記**：標記特定使用者的訊息
- **📝 多行訊息處理**：正確處理包含換行的訊息
- **🛡️ 錯誤處理**：優雅的檔案權限和格式錯誤處理
- **👥 使用者名冊**：支援預設使用者名冊進行精確匹配

## 📁 檔案結構

```
chat_log_cleaner/
├── config.json                    # 配置文件
├── user_directory_example.json    # 使用者名冊範例檔案（可公開）
├── data/
│   ├── raw/                      # 原始聊天記錄檔案 (.txt)
│   ├── output/                   # 輸出CSV檔案
│   └── user_directory.json       # 使用者名冊（包含個資，不上傳）
├── src/
│   ├── main.py                   # 主程式
│   ├── chat_parser.py            # 聊天記錄解析器
│   ├── smart_user_identifier.py  # 智能使用者識別器
│   ├── user_identifier.py        # 傳統使用者識別器（備用）
│   ├── user_directory_manager.py # 使用者名冊管理器
│   ├── utils.py                  # 工具函數
│   └── TreeMaker.py              # 目錄樹生成器
├── requirements.txt              # Python依賴套件
└── README.md                     # 說明文件
```

## 🛠️ 安裝與使用

### 1. 安裝依賴套件

```bash
pip install -r requirements.txt
```

### 2. 準備原始檔案

將聊天記錄檔案（.txt格式）放入 `data/raw/` 目錄中。

### 3. 配置設定

編輯 `config.json` 檔案：

```json
{
  "date_range": {
    "start": "2021-01-01",
    "end": "2025-12-31"
  },
  "watchlist_users": [
    "關注用戶1",
    "關注用戶2"
  ],
  "exclude_keywords": [
    "加入聊天",
    "退出社群",
    "退出群組",
    "封鎖",
    "解除封鎖"
  ],
  "watchlist_keywords": [
    "維修",
    "道歉",
    "客人",
    "有錢",
    "社會中堅",
    "小屁孩"
  ],
  "analysis_settings": {
    "sample_count_智能識別樣本數量": 50,
    "traditional_sample_count_傳統識別樣本數量": 20,
    "min_frequency_private_私聊最小頻率": 0.05,
    "min_frequency_group_社群最小頻率": 0.02,
    "min_content_diversity_最小內容多樣性": 0.05,
    "max_user_name_length_用戶名最大長度": 50,
    "min_user_name_length_用戶名最小長度": 2
  },
  "parsing_settings": {
    "emoji_chars": ["😀", "😂", "😅", "🙏", "～"],
    "content_indicators": ["貼圖", "圖片", "影片", "語音訊息", "檔案", "位置"],
    "conversation_starters": ["嗨嗨", "想跟你討教", "順便問一下", "我還是先", "我把樓上", "合約都", "然後", "User～"],
    "content_start_words": ["youtote", "Momo", "My", "From", "One", "【", "Lalamove", "下載位置"],
    "system_keywords": ["加入聊天", "退出群組", "退出社群", "封鎖", "解除封鎖"],
    "excluded_users": ["咻咻咻", "點", "瑪菈緹雅", "嵐", "Bruce"],
    "bot_keywords": ["bot", "廣告", "spam", "auto"]
  }
}
```

### 4. 設定使用者名冊（可選）

為了提高使用者識別的準確性，您可以建立使用者名冊：

1. **複製範例檔案**：
   ```bash
   cp user_directory_example.json data/user_directory.json
   ```

2. **編輯使用者名冊**：
   根據您的聊天記錄修改 `data/user_directory.json` 中的使用者名稱列表：
   ```json
   {
     "users": [
       "您的使用者名稱1",
       "您的使用者名稱2",
       "完整的使用者名稱"
     ],
     "metadata": {
       "version": "2.0",
       "description": "簡化版使用者名冊，僅包含完整使用者名稱",
       "max_length": 50,
       "match_type": "exact"
     }
   }
   ```

3. **注意事項**：
   - 每個使用者名稱最多50字元
   - 系統會進行完全比對，避免內容被誤認為使用者名稱
   - 如果不設定使用者名冊，系統會使用智能識別功能
   - **隱私保護**：`data/user_directory.json` 包含個資，不會被上傳到 Git

### 5. 執行程式

```bash
python src/main.py
```

## 📊 輸出格式

程式會生成CSV檔案，包含以下欄位：

- **日期**：訊息日期 (YYYY-MM-DD)
- **時間**：訊息時間 (HH:MM)
- **使用者**：智能識別後的使用者名稱
- **訊息內容**：訊息文字內容
- **是否關注對象**：布林值，標記是否為關注對象

## 🔧 支援的聊天記錄格式

### 日期格式
- `2023.01.03 星期二`
- `2023/1/3（週二）`

### 訊息格式
- **製表符分隔**：`12:04\t使用者名稱\t訊息內容`
- **標準空格分隔**：`12:04 使用者名稱 訊息內容`
- **社群格式**：`12:04 複雜使用者名稱 訊息內容`
- **寬鬆格式**：適應各種複雜格式

## ⚙️ 配置參數說明

### analysis_settings（分析設定）
- `sample_count_智能識別樣本數量`：智能識別使用的樣本數量
- `traditional_sample_count_傳統識別樣本數量`：傳統識別使用的樣本數量
- `min_frequency_private_私聊最小頻率`：私聊環境的最小出現頻率閾值
- `min_frequency_group_社群最小頻率`：社群環境的最小出現頻率閾值
- `min_content_diversity_最小內容多樣性`：最小內容多樣性要求
- `max_user_name_length_用戶名最大長度`：使用者名稱最大長度限制
- `min_user_name_length_用戶名最小長度`：使用者名稱最小長度限制

### parsing_settings（解析設定）
- `emoji_chars`：表情符號字符列表，用於識別非使用者名稱
- `content_indicators`：內容標記列表，用於識別特殊內容類型
- `conversation_starters`：對話開頭詞列表，用於識別內容開始
- `content_start_words`：內容開頭詞列表，用於識別特定內容類型
- `system_keywords`：系統關鍵字列表，用於識別系統訊息
- `excluded_users`：排除的使用者名稱列表
- `bot_keywords`：機器人關鍵字列表，用於識別機器人帳號

### 其他設定
- `watchlist_users`：關注使用者列表，這些使用者的訊息會被標記為關注對象
- `exclude_keywords`：排除關鍵字列表，包含這些關鍵字的訊息會被過濾掉
- `watchlist_keywords`：關注關鍵字列表，包含這些關鍵字的訊息會被標記為關注對象

## 🧠 智能識別功能

### 自動格式檢測
程式會自動檢測聊天記錄類型：
- **私聊模式**：2-3個使用者，較高頻率要求（5%）
- **社群模式**：多個使用者，降低頻率要求（2%）

### 智能使用者識別
採用三層識別策略：

#### 第一層：使用者名冊比對（可選）
- **完全比對**：與預設使用者名冊進行精確匹配
- **高準確性**：避免內容被誤認為使用者名稱
- **快速識別**：優先處理已知使用者

#### 第二層：統計分析識別
基於統計分析的前50條訊息：

1. **頻率分析**：統計使用者出現頻率
2. **內容多樣性**：分析使用者內容的多樣性
3. **格式特徵**：檢查使用者名稱的複雜度
4. **系統訊息過濾**：自動排除系統訊息
5. **機器人過濾**：排除廣告和機器人帳號

#### 第三層：啟發式規則
- **內容標記識別**：貼圖、圖片、影片等
- **表情符號識別**：😀、😂、😅等
- **URL識別**：http開頭的連結
- **對話內容識別**：常見對話開頭詞
- **名稱模式識別**：下劃線、中英文混合等

### 識別指標
- **出現頻率**：私聊≥5%，社群≥2%
- **內容多樣性**：私聊≥10%，社群≥5%
- **名稱長度**：2-50個字符
- **格式檢查**：排除純數字、純符號等

### 特殊處理
- **"Unknown" 使用者**：正確識別為真正使用者（離群成員）
- **複雜名稱**：支援下劃線、中英文混合等格式
- **變體映射**：自動映射相似的使用者名稱

## 📈 處理結果示例

### 私聊檔案
```
檢測到聊天格式：私聊
識別出 2 個真正使用者：
  1. 使用者A (出現 26 次，頻率 52.00%)
  2. 使用者B (出現 24 次，頻率 48.00%)
```

### 社群檔案
```
檢測到聊天格式：社群
識別出 5 個真正使用者：
  1. Unknown (出現 43 次，頻率 86.00%)
  2. 使用者C (出現 4 次，頻率 8.00%)
  3. 使用者D (出現 1 次，頻率 2.00%)
  4. 使用者E (出現 1 次，頻率 2.00%)
  5. 使用者F (出現 1 次，頻率 2.00%)
```

## ⚙️ 自定義配置

### 調整識別參數
在 `config.json` 的 `analysis_settings` 區塊中修改：

#### 樣本數量設定
- **`sample_count_智能識別樣本數量`**：智能識別分析的樣本數量
  - 建議範圍：30-100，數量太少可能識別不準確，太多會影響處理速度
- **`traditional_sample_count_傳統識別樣本數量`**：傳統識別分析的樣本數量
  - 備用識別方法，通常不需要調整

#### 頻率閾值設定
- **`min_frequency_private_私聊最小頻率`**：私聊環境最小出現頻率
  - 私聊中使用者出現頻率較高，建議保持5%以上
- **`min_frequency_group_社群最小頻率`**：社群環境最小出現頻率
  - 社群中使用者較多，頻率較低，建議2%以上

#### 內容品質設定
- **`min_content_diversity_最小內容多樣性`**：最小內容多樣性要求
  - 防止機器人或重複內容，建議5%以上
- **`max_user_name_length_用戶名最大長度`**：使用者名稱最大長度
  - 過長的名稱可能是系統訊息
- **`min_user_name_length_用戶名最小長度`**：使用者名稱最小長度
  - 過短的名稱可能是符號或表情

> **重要提醒**：所有參數現在都必須在 `config.json` 中設定，腳本不再使用硬編碼的預設值。請確保 `config.json` 包含所有必要的參數。

### 新增關鍵字過濾
在 `config.json` 的 `exclude_keywords` 陣列中添加關鍵字。

### 自定義使用者映射
在 `src/user_identifier.py` 中修改 `full_name_patterns` 字典。

## 🛡️ 錯誤處理

### 檔案權限問題
- **自動重試**：最多重試3次
- **等待機制**：每次重試間隔2秒
- **詳細錯誤訊息**：清楚說明問題和解決方法

### 格式錯誤處理
- **寬鬆解析**：支援多種格式變體
- **錯誤跳過**：跳過無法解析的行
- **統計報告**：顯示處理結果統計

## 📋 注意事項

1. **隱私保護**：請確保移除所有個人資料後再公開程式碼
2. **編碼格式**：原始檔案應使用UTF-8編碼
3. **檔案大小**：大型檔案處理可能需要較長時間
4. **記憶體使用**：處理大量資料時注意記憶體使用量
5. **檔案鎖定**：確保輸出檔案未被其他程式開啟

## 🔄 版本更新

### v2.1 使用者名冊版本
- ✅ 新增使用者名冊功能
- ✅ 完全比對機制，避免內容誤判
- ✅ 簡化JSON格式，易於維護
- ✅ 隱私保護機制，個資不上傳
- ✅ 範例檔案提供，方便使用

### v2.0 智能識別版本
- ✅ 新增智能使用者識別功能
- ✅ 自動格式檢測（私聊/社群）
- ✅ 統計分析識別算法
- ✅ 社群環境優化
- ✅ 改進錯誤處理機制
- ✅ 簡化專案結構

## 📄 授權

此專案僅供學習和研究使用，請遵守相關隱私保護法規。

---

**作者**：楊翔志 & AI Collective  
**版本**：v2.1  
**更新日期**：2025-08-01
