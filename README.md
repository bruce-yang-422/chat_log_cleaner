# 聊天記錄清洗工具

這是一個用於清洗和處理聊天記錄的工具，可以將原始聊天記錄轉換為結構化的CSV格式。支援智能使用者識別、多格式聊天記錄解析和社群環境優化。

## 🚀 功能特色

- **🤖 智能使用者識別**：基於統計分析自動識別真正使用者
- **📊 格式自動檢測**：自動識別私聊和社群格式
- **🔄 多格式支援**：支援製表符、空格分隔等多種格式
- **📅 時間戳解析**：正確處理多種時間格式
- **🔍 日期過濾**：根據設定的日期範圍過濾訊息
- **🚫 關鍵字過濾**：排除包含特定關鍵字的訊息
- **⭐ 關注對象標記**：標記特定使用者的訊息
- **📝 多行訊息處理**：正確處理包含換行的訊息
- **🛡️ 錯誤處理**：優雅的檔案權限和格式錯誤處理

## 📁 檔案結構

```
chat_log_cleaner/
├── config.json                    # 配置文件
├── data/
│   ├── raw/                      # 原始聊天記錄檔案 (.txt)
│   └── output/                   # 輸出CSV檔案
├── src/
│   ├── main.py                   # 主程式
│   ├── chat_parser.py            # 聊天記錄解析器
│   ├── smart_user_identifier.py  # 智能使用者識別器
│   ├── user_identifier.py        # 傳統使用者識別器（備用）
│   ├── utils.py                  # 工具函數
│   └── TreeMaker.py              # 目錄樹生成器
├── requirements.txt              # Python依賴套件
└── README.md                     # 說明文件
```

## 🛠️ 安裝與使用

### 1. 安裝依賴套件

```bash
pip install -r requirements.txt
```

### 2. 準備原始檔案

將聊天記錄檔案（.txt格式）放入 `data/raw/` 目錄中。

### 3. 配置設定

編輯 `config.json` 檔案：

```json
{
  "date_range": {
    "start": "2021-01-01",
    "end": "2025-12-31"
  },
  "watchlist_users": [
    "關注用戶1",
    "關注用戶2"
  ],
  "exclude_keywords": [
    "加入聊天",
    "退出社群",
    "退出群組",
    "封鎖",
    "解除封鎖"
  ]
}
```

### 4. 執行程式

```bash
python src/main.py
```

## 📊 輸出格式

程式會生成CSV檔案，包含以下欄位：

- **日期**：訊息日期 (YYYY-MM-DD)
- **時間**：訊息時間 (HH:MM)
- **使用者**：智能識別後的使用者名稱
- **訊息內容**：訊息文字內容
- **是否關注對象**：布林值，標記是否為關注對象

## 🔧 支援的聊天記錄格式

### 日期格式
- `2023.01.03 星期二`
- `2023/1/3（週二）`

### 訊息格式
- **製表符分隔**：`12:04\t使用者名稱\t訊息內容`
- **標準空格分隔**：`12:04 使用者名稱 訊息內容`
- **社群格式**：`12:04 複雜使用者名稱 訊息內容`
- **寬鬆格式**：適應各種複雜格式

## 🧠 智能識別功能

### 自動格式檢測
程式會自動檢測聊天記錄類型：
- **私聊模式**：2-3個使用者，較高頻率要求（5%）
- **社群模式**：多個使用者，降低頻率要求（2%）

### 智能使用者識別
基於統計分析的前50條訊息：

1. **頻率分析**：統計使用者出現頻率
2. **內容多樣性**：分析使用者內容的多樣性
3. **格式特徵**：檢查使用者名稱的複雜度
4. **系統訊息過濾**：自動排除系統訊息
5. **機器人過濾**：排除廣告和機器人帳號

### 識別指標
- **出現頻率**：私聊≥5%，社群≥2%
- **內容多樣性**：私聊≥10%，社群≥5%
- **名稱長度**：2-50個字符
- **格式檢查**：排除純數字、純符號等

### 特殊處理
- **"Unknown" 使用者**：正確識別為真正使用者（離群成員）
- **複雜名稱**：支援下劃線、中英文混合等格式
- **變體映射**：自動映射相似的使用者名稱

## 📈 處理結果示例

### 私聊檔案
```
檢測到聊天格式：私聊
識別出 2 個真正使用者：
  1. 使用者A (出現 26 次，頻率 52.00%)
  2. 使用者B (出現 24 次，頻率 48.00%)
```

### 社群檔案
```
檢測到聊天格式：社群
識別出 5 個真正使用者：
  1. Unknown (出現 43 次，頻率 86.00%)
  2. 使用者C (出現 4 次，頻率 8.00%)
  3. 使用者D (出現 1 次，頻率 2.00%)
  4. 使用者E (出現 1 次，頻率 2.00%)
  5. 使用者F (出現 1 次，頻率 2.00%)
```

## ⚙️ 自定義配置

### 調整識別參數
在 `src/smart_user_identifier.py` 中修改：
- `sample_count`：分析樣本數量（預設50）
- `min_frequency`：最小出現頻率
- `content_diversity`：內容多樣性要求

### 新增關鍵字過濾
在 `config.json` 的 `exclude_keywords` 陣列中添加關鍵字。

### 自定義使用者映射
在 `src/user_identifier.py` 中修改 `full_name_patterns` 字典。

## 🛡️ 錯誤處理

### 檔案權限問題
- **自動重試**：最多重試3次
- **等待機制**：每次重試間隔2秒
- **詳細錯誤訊息**：清楚說明問題和解決方法

### 格式錯誤處理
- **寬鬆解析**：支援多種格式變體
- **錯誤跳過**：跳過無法解析的行
- **統計報告**：顯示處理結果統計

## 📋 注意事項

1. **隱私保護**：請確保移除所有個人資料後再公開程式碼
2. **編碼格式**：原始檔案應使用UTF-8編碼
3. **檔案大小**：大型檔案處理可能需要較長時間
4. **記憶體使用**：處理大量資料時注意記憶體使用量
5. **檔案鎖定**：確保輸出檔案未被其他程式開啟

## 🔄 版本更新

### v2.0 智能識別版本
- ✅ 新增智能使用者識別功能
- ✅ 自動格式檢測（私聊/社群）
- ✅ 統計分析識別算法
- ✅ 社群環境優化
- ✅ 改進錯誤處理機制
- ✅ 簡化專案結構

## 📄 授權

此專案僅供學習和研究使用，請遵守相關隱私保護法規。
